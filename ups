#!/usr/bin/python
# ups, package manager for linux-based operating systems (though I'm
# pretty sure it'd work on BSDs and derivatives and other Unix-likes)
# written by dbro and licensed under version 3 of the GNU General
# Public License.

# IMPORTS:

import sys
import os
from urllib import urlopen
import tarfile
import bz2
import json

version = "0.5.1"

# BACKEND CODE:

binrepo = "http://www.sites.google.com/site/upspackagemanager/repository/bin/"
srcrepo = "http://www.sites.google.com/site/upspackagemanager/repository/src/"
pkglist = "/usr/share/ups-pkg-list.txt"
pkgdb = "http://www.sites.google.com/site/upspackagemanager/repository/ups-db.txt"

def pkginstall( pkg ):
	# This installs the specified package.
	filename = str(pkg)+".tar.bz2"
	address = binrepo+filename
	pkginfo = str(pkg)+"_info.json"
	
	print "Downloading and extracting package..."
	
	archive = urlopen(address, 'r').read()
	
	os.chdir("/etc/ups")									# All of the credit here goes to Hollinski
	
	archive0 = open(filename, 'wb')
	archive0.write(archive)
	archive0.close()
	
	bz2.decompress(filename)
	
	archive1 = tarfile.open(filename, 'r')
	archive1.extract(pkginfo)
	
	
	jsonstuff = json.load(pkginfo)
	
	# Install dependencies:
	for dep in jsonstuff["depends"]:
		pkginstall( dep )
	
	for dir_ in jsonstuff["path_map"]:
		for member_name in jsonstuff["path_map"][dir_]:
			
			dest = os.path.join(dir_, member_name)
	
			print "Unpacking '{member}' to '{dest}'".format(member=member_name, dest=dest)

		# Assuming a method like this is provided by TarFile
		archive.extract(member_name, dest)
	
	archive1.close()
	
	log0 = open(pkglist, 'a')
	
	log0.write( pkg )

def pkgremove( rmpkg ):
	# Removes the specified package.
	# Author's comments: This will be the easiest one to write (not that the other two were difficult.)
	os.chdir("/usr/bin")
	os.remove( rmpkg )
	os.chdir("/etc/ups")
	os.remove( rmpkg+"_info.txt" )

def showvers():
	print "ups"
	print "version "+str(version)

def showcredits():
	print "ups"
	print "\ndeveloped and programmed by draven stedman"
	print "with a bit of help from hollinski"
	
def pkgupdate(pkg0):
	os.chdir("/usr/bin")
	os.remove( pkg0 )
	pkginstall( pkg0 )

def updateallpkg():
	b = open(pkgList, 'r')
	for c in b:
		c = c.rstrip()
		pkgupdate(c)
		print "Update of package '"+c+"' completed."
	b.close()
	print "Update of all packages completed."

# FRONTEND CODE:


try:
	if sys.argv[1] == "install":
		try:
			pkginstall( sys.argv[2] )
		except IndexError:
			print "No package given."
	elif sys.argv[1] == "remove":
		try:
			pkgremove( sys.argv[2] )
		except IndexError:
			print "No package given."
	elif sys.argv[1] == "update":
		try:
			pkgupdate( sys.argv[2] )
		except IndexError:
			print "No package given."
	elif sys.argv[1] == "--credits":
		showcredits()
	elif sys.argv[1] == "--version":
		showvers()
	else:
		print "usage: ups --credits"
		print "		  ups --version"
		print "       ups [operation] [package]"
except IndexError:
	print "usage: ups --credits"
	print "       ups --version"
	print "       ups [operation] [package]"
